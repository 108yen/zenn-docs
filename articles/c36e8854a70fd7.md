---
title: "App Routerã§fetchã‚’ä½¿ãˆãªã„å ´åˆã®ISRã«ã¤ã„ã¦"
emoji: "ğŸŒ"
type: "tech"
topics:
  - "nextjs"
  - "vercel"
  - "isr"
  - "approuter"
published: true
published_at: "2023-10-13 18:37"
---

# ã¯ã˜ã‚ã«

App Routerã§ISRãŒã§ãã‚‹fetché–¢æ•°ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ãŒã€HTTPãƒ™ãƒ¼ã‚¹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã—ã‹å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚firestoreã‚„supabaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸã„å ´åˆã«ã©ã†ã™ã¹ãã‹ã¨ã„ã†è¨˜äº‹ãŒè¦‹å½“ãŸã‚‰ãªã‹ã£ãŸã®ã§ã€æŠ•ç¨¿ã—ã¾ã—ãŸã€‚
ã‚‚ã£ã¨ã„ã„æ–¹æ³•ã‚’çŸ¥ã£ã¦ã„ã‚‹æ–¹ãŒã„ã‚Œã°ã€æ•™ãˆã¦ã„ãŸã ããŸã„ã§ã™ã€‚ï¼ˆã“ã£ã¡ãŒæœ¬é¡Œï¼‰

```ts
export default async function Page() {
ã€€const res = await fetch('https://api.example.com/...', { next: { revalidate: 3600 } })
  const data = res.json()

  return <Home data={data} />
}
```

https://nextjs.org/docs/app/building-your-application/data-fetching/fetching-caching-and-revalidating#fetching-data-on-the-server-with-fetch

# çµè«–

ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã¨ã€ISRã«ãªã‚Šã¾ã™ã€‚
60ç§’é–“ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒæ¸¡ã•ã‚Œã‚‹ãŸã‚ã€ãã®é–“ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªãŒè¡Œã‚ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```tsx:page.tsx
import { getData } from './utils'

export const revalidate = 60

export default async function Page() {
ã€€const data = await getData('id')

  return <Home data={data} />
}
```

```tsx:utils.tsx
import { cache } from 'react'

export const getData = cache(async (id: string) => {
  const data = await db.query('...')
  return data
})
```

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã«è¨˜è¼‰ãŒã‚ã‚Šã¾ã—ãŸã€‚
https://nextjs.org/docs/app/building-your-application/data-fetching/fetching-caching-and-revalidating#fetching-data-on-the-server-with-third-party-libraries

> If the segment is static (default), the output of the request will be cached and revalidated as part of the route segment.

> ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒé™çš„ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) ã®å ´åˆã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡ºåŠ›ã¯ãƒ«ãƒ¼ãƒˆ ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ä¸€éƒ¨ã¨ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã€å†æ¤œè¨¼ã•ã‚Œã¾ã™ã€‚

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ãƒšãƒ¼ã‚¸ã®å®¹é‡ãŒå¤§ããã†ãªå ´åˆã¯ã€`cacheMaxMemorySize`ã‚’è¨­å®šã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯`50M`ã§ã™ã€‚
:::message
ãŠãã‚‰ãã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ãƒšãƒ¼ã‚¸ã”ã¨ã®å®¹é‡ã§ã€ã“ã“ã§æŒ‡å®šã—ãŸå®¹é‡ã‚’è¶…ãˆã‚‹å ´åˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã›ã‚“ã€‚
:::

```js:next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  cacheMaxMemorySize: 50 * 1024 * 1024 // 50M
}

module.exports = nextConfig

```

# cache

å…¬å¼ãƒšãƒ¼ã‚¸ã®ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã«reactã®cacheã‚’ä½¿ã†ã¨ã€fetchã‚’åˆ©ç”¨ã§ããªã„ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒã§ãã‚‹ã¨è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚
cacheã‚’ä½¿ã‚ãªã„ã¨ã€revalidateã§æŒ‡å®šã—ãŸæ™‚é–“ãŒãŸã£ã¦ã„ãªãã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ã®å†æ¤œè¨¼ãŒã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã€ä½¿ã£ãŸæ–¹ãŒå®‰å®šã™ã‚‹ã®ã§åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
page.tsxå†…ã«è¨˜è¼‰ã™ã‚‹revalidateã¯pageã®ç”Ÿæˆé–“éš”ã¨ã„ã†ã‚ˆã‚Šã¯ã€ãƒšãƒ¼ã‚¸ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹é–“éš”ãªã®ã‹ãªã¨æ¨æ¸¬ã—ã¦ã„ã¾ã™ã€‚
https://nextjs.org/docs/app/building-your-application/data-fetching/fetching-caching-and-revalidating#fetching-data-on-the-server-with-third-party-libraries
cacheã‚’ä½¿ã†ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«layout.tsxã¨page.tsxã§åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã¨ãã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã®ã§ã€dbã¸ã®ã‚¯ã‚¨ãƒªã¯1å›ã§æ¸ˆã¿ã¾ã™ã€‚
ãŸã ã€Dynamic Routesã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€revalidateã§æŒ‡å®šã—ãŸå€¤ãŒç„¡è¦–ã•ã‚Œã¦ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã³ã«ã‚¯ã‚¨ãƒªãŒèµ°ã‚Šã¾ã™ã€‚

```tsx:app/item/[id]/layout.tsx
import { getData } from './utils'

export const revalidate = 60

export default async function Layout({
  params: { id },
}: {
  params: { id: string }
}) {
  const item = await getData(id)
  // ...
}
```

```tsx:app/item/[id]/page.tsx
import { getData } from './utils'

export const revalidate = 60

export default async function Page({
  params: { id },
}: {
  params: { id: string }
}) {
ã€€const data = await getData(id)

  return <ItemPage data={data} />
}
```

# unstable_cache

ã“ã‚ŒãŒä»Šå›æ±‚ã‚ã¦ã„ãŸæ©Ÿèƒ½ã§ã™ãŒã€å…¬å¼ã®è¨˜è¼‰ã§ã‚‚ã‚ã‚‹é€šã‚Šã€ã¾ã é–‹ç™ºä¸­ã®ã‚ˆã†ã§ã™ã€‚
https://nextjs.org/docs/app/building-your-application/caching#unstable_cache

ä½¿ã„æ–¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã‹ãªã¨æ€ã„ã¾ã™ã€‚
å®Ÿéš›ä½¿ã£ã¦ã¿ãŸã¨ã“ã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ä¸Šã§ãƒ‡ãƒãƒƒã‚°ã—ãŸæ™‚ã¯ã¡ã‚ƒã‚“ã¨å‹•ã„ã¦ã„ãã§ã—ãŸãŒã€Vercelã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã€ãƒ“ãƒ«ãƒ‰æ™‚ä»¥å¤–ã¯å®Ÿè¡Œã•ã‚Œãšã€ãŸã ã®SSRã«ãªã‚Šã¾ã—ãŸã€‚

```ts
import { unstable_cache } from 'next/cache'

export default async function Page() {
  const data = await unstable_cache(
    async () => {
      const data = await db.query('...')
      return data
    },
    ['cache-key'],
    {
      tags: ['a', 'b', 'c'],
      revalidate: 10,
    }
  )()
  return <Home data={data} />
}
```

ã„ã‚ã„ã‚è©¦ã—ãŸã¨ãã®ã‚µã‚¤ãƒˆã§ã™ã€‚
https://isr-test-bay.vercel.app/

# ã‚ã¨ãŒã

ã“ã®ã‚ãŸã‚ŠãŒã¾ã¨ã¾ã£ãŸè¨˜äº‹ãŒãªãã€è‡ªåˆ†ã¯ã“ã®éƒ¨åˆ†ã§ã ã„ã¶æ™‚é–“ã‚’ä½¿ã£ã¦ã—ã¾ã£ãŸã®ã§ã€èª°ã‹ã®ä¸€åŠ©ã«ãªã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

# è£œè¶³

ISRã‚’ã™ã‚‹ã¨ãã¯next/linkã®prefetchã«falseã‚’è¨­å®šã—ãŸã»ã†ãŒã‚ˆã•ãã†ã§ã™ã€‚
æŒ‡å®šã—ã¦ã„ãªã„ã¨ã€ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸéš›ã€Linkã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ãŒrevalidateã§æŒ‡å®šã—ãŸæœŸé–“ã¯é–¢ä¿‚ãªãå†æ¤œè¨¼ã•ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã ã¨ã€Homeã®ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸéš›ã€pageAã€pageBã‚‚å†æ¤œè¨¼ã•ã‚Œã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/f2f592f4bad4-20231016.png)

```ts
import Link from "next/link";

export default function Home() {
  return (
    <main>
      <h1>Home</h1>
      <Link href='/pageA'>
      ã€€pageA
      </Link>
      <br />
      <Link href='/pageB'>
      ã€€pageB
      </Link>
    </main>
  )
}
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€prefetch={false}ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ãƒªãƒ³ã‚¯å…ˆã®ãƒšãƒ¼ã‚¸ã¯å†æ¤œè¨¼ã•ã‚Œã¾ã›ã‚“ã€‚

```ts
import Link from "next/link";

export default function Home() {
  return (
    <main>
      <h1>Home</h1>
      <Link href='/pageA' prefetch={false}>
      ã€€pageA
      </Link>
      <br />
      <Link href='/pageB' prefetch={false}>
      ã€€pageB
      </Link>
    </main>
  )
}
```
